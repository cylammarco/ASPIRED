
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>aspired &#8212; ASPIRED 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for aspired</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">astropy</span> <span class="k">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="k">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.nddata</span> <span class="k">import</span> <span class="n">CCDData</span>
<span class="kn">from</span> <span class="nn">ccdproc</span> <span class="k">import</span> <span class="n">Combiner</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="k">import</span> <span class="n">interpolate</span> <span class="k">as</span> <span class="n">itp</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">minimize</span>

<span class="kn">from</span> <span class="nn">rascal.calibrator</span> <span class="k">import</span> <span class="n">Calibrator</span>
<span class="kn">from</span> <span class="nn">rascal.util</span> <span class="k">import</span> <span class="n">load_calibration_lines</span>
<span class="kn">from</span> <span class="nn">rascal.util</span> <span class="k">import</span> <span class="n">refine_peaks</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">astroscrappy</span> <span class="k">import</span> <span class="n">detect_cosmics</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warn</span><span class="p">(</span>
        <span class="n">AstropyWarning</span><span class="p">(</span><span class="s1">&#39;astroscrappy is not present, so ap_trace will clean &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;cosmic rays with a 2D-median filter of size 5.&#39;</span><span class="p">))</span>
<div class="viewcode-block" id="detect_cosmics"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.detect_cosmics">[docs]</a>    <span class="n">detect_cosmics</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">medfilt2d</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></div>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">spectres</span> <span class="k">import</span> <span class="n">spectres</span>
<div class="viewcode-block" id="spectres_imported"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.spectres_imported">[docs]</a>    <span class="n">spectres_imported</span> <span class="o">=</span> <span class="kc">True</span></div>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s1">&#39;spectres is not present, spectral resampling cannot be performed. &#39;</span>
        <span class="s1">&#39;Flux calibration is suboptimal. Flux is not conserved.&#39;</span><span class="p">)</span>
    <span class="n">spectres_imported</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
    <span class="kn">import</span> <span class="nn">plotly.io</span> <span class="k">as</span> <span class="nn">pio</span>
<div class="viewcode-block" id="plotly_imported"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.plotly_imported">[docs]</a>    <span class="n">plotly_imported</span> <span class="o">=</span> <span class="kc">True</span></div>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s1">&#39;plotly is not present, diagnostic plots cannot be generated.&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">aspired.standard_list</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="ImageReduction"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction">[docs]</a><span class="k">class</span> <span class="nc">ImageReduction</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">filelistpath</span><span class="p">,</span>
                 <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span>
                 <span class="n">saxis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">saxis_keyword</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">combinetype_light</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                 <span class="n">sigma_clipping_light</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">clip_low_light</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">clip_high_light</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">exptime_light</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exptime_light_keyword</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">combinetype_dark</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                 <span class="n">sigma_clipping_dark</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">clip_low_dark</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">clip_high_dark</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">exptime_dark</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exptime_dark_keyword</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">combinetype_bias</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                 <span class="n">sigma_clipping_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">clip_low_bias</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">clip_high_bias</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">combinetype_flat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                 <span class="n">sigma_clipping_flat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">clip_low_flat</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">clip_high_flat</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">silence</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This class is not intented for quality data reduction, it exists for</span>
<span class="sd">        completeness such that users can produce a minimal pipeline with</span>
<span class="sd">        a single pacakge. Users should preprocess calibration frames, for</span>
<span class="sd">        example, arc frames taken with long and short exposures for</span>
<span class="sd">        wavelength calibration with both bright and faint lines; fringing</span>
<span class="sd">        correction of flat frames; light frames with various exposure times.</span>

<span class="sd">        If a field-flattening 2D spectrum is already avaialble, it can be</span>
<span class="sd">        the only listed item. Set it as a &#39;light&#39; frame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filelistpath: string</span>
<span class="sd">            file location, does not support URL</span>
<span class="sd">        ftype: string, optional</span>
<span class="sd">            one of csv, tsv and ascii. Default is csv.</span>
<span class="sd">        Sxais: int, 0 or 1</span>
<span class="sd">            OVERRIDE the SAXIS value in the FITS header, or to provide the</span>
<span class="sd">            SAXIS if it does not exist</span>
<span class="sd">        saxis_keyword: string</span>
<span class="sd">            HDU keyword for the spectral axis direction</span>
<span class="sd">        combinetype_light: string, optional</span>
<span class="sd">            average of median for CCDproc.Combiner.average_combine() and</span>
<span class="sd">            CCDproc.Combiner.median_combine(). All the frame types follow</span>
<span class="sd">            the same combinetype.</span>
<span class="sd">        sigma_clipping_light: tuple</span>
<span class="sd">            perform sigma clipping if set to True. sigma is computed with the</span>
<span class="sd">            numpy.ma.std method</span>
<span class="sd">        clip_low_light: float</span>
<span class="sd">            lower threshold of the sigma clipping</span>
<span class="sd">        clip_high_light: float</span>
<span class="sd">            upper threshold of the sigma clipping</span>
<span class="sd">        exptime_light: float</span>
<span class="sd">            OVERRIDE the exposure time value in the FITS header, or to provide</span>
<span class="sd">            one if the keyword does not exist</span>
<span class="sd">        exptime_light_keyword: string</span>
<span class="sd">            HDU keyword for the exposure time of the light frame</span>
<span class="sd">        combinetype_dark: string, optional</span>
<span class="sd">            average of median for CCDproc.Combiner.average_combine() and</span>
<span class="sd">            CCDproc.Combiner.median_combine(). All the frame types follow</span>
<span class="sd">            the same combinetype.</span>
<span class="sd">        sigma_clipping_dark: tuple</span>
<span class="sd">            perform sigma clipping if set to True. sigma is computed with the</span>
<span class="sd">            numpy.ma.std method</span>
<span class="sd">        clip_low_dark: float</span>
<span class="sd">            lower threshold of the sigma clipping</span>
<span class="sd">        clip_high_dark: float</span>
<span class="sd">            upper threshold of the sigma clipping</span>
<span class="sd">        exptime_dark: float</span>
<span class="sd">            OVERRIDE the exposure time value in the FITS header, or to provide</span>
<span class="sd">            one if the keyword does not exist</span>
<span class="sd">        exptime_dark_keyword: string</span>
<span class="sd">            HDU keyword for the exposure time of the dark frame</span>
<span class="sd">        combinetype_bias: string, optional</span>
<span class="sd">            average of median for CCDproc.Combiner.average_combine() and</span>
<span class="sd">            CCDproc.Combiner.median_combine(). All the frame types follow</span>
<span class="sd">            the same combinetype.</span>
<span class="sd">        sigma_clipping_bias: tuple</span>
<span class="sd">            perform sigma clipping if set to True. sigma is computed with the</span>
<span class="sd">            numpy.ma.std method</span>
<span class="sd">        clip_low_bias: float</span>
<span class="sd">            lower threshold of the sigma clipping</span>
<span class="sd">        clip_high_bias: float</span>
<span class="sd">            upper threshold of the sigma clipping</span>
<span class="sd">        combinetype_flat: string, optional</span>
<span class="sd">            average of median for CCDproc.Combiner.average_combine() and</span>
<span class="sd">            CCDproc.Combiner.median_combine(). All the frame types follow</span>
<span class="sd">            the same combinetype.</span>
<span class="sd">        sigma_clipping_flat: tuple</span>
<span class="sd">            perform sigma clipping if set to True. sigma is computed with the</span>
<span class="sd">            numpy.ma.std method</span>
<span class="sd">        clip_low_flat: float</span>
<span class="sd">            lower threshold of the sigma clipping</span>
<span class="sd">        clip_high_flat: float</span>
<span class="sd">            upper threshold of the sigma clipping</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filelistpath</span> <span class="o">=</span> <span class="n">filelistpath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">ftype</span>
        <span class="k">if</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span>
        <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;tsv&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;ascii&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>

        <span class="c1"># FITS keyword standard recommends XPOSURE, but most observatories</span>
        <span class="c1"># use EXPTIME for supporting iraf. Also included a few other keywords</span>
        <span class="c1"># which are the proxy-exposure times at best. ASPIRED will use the</span>
        <span class="c1"># first keyword found on the list, if all failed, an exposure time of</span>
        <span class="c1"># 1 second will be applied. A warning will be promted.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime_keyword</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;XPOSURE&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPTIME&#39;</span><span class="p">,</span> <span class="s1">&#39;EXPOSED&#39;</span><span class="p">,</span> <span class="s1">&#39;TELAPSED&#39;</span><span class="p">,</span> <span class="s1">&#39;ELAPSED&#39;</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_light</span> <span class="o">=</span> <span class="n">combinetype_light</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_light</span> <span class="o">=</span> <span class="n">sigma_clipping_light</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_low_light</span> <span class="o">=</span> <span class="n">clip_low_light</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_high_light</span> <span class="o">=</span> <span class="n">clip_high_light</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime_light</span> <span class="o">=</span> <span class="n">exptime_light</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime_light_keyword</span> <span class="o">=</span> <span class="n">exptime_light_keyword</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_dark</span> <span class="o">=</span> <span class="n">combinetype_dark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_dark</span> <span class="o">=</span> <span class="n">sigma_clipping_dark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_low_dark</span> <span class="o">=</span> <span class="n">clip_low_dark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_high_dark</span> <span class="o">=</span> <span class="n">clip_high_dark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span> <span class="o">=</span> <span class="n">exptime_dark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark_keyword</span> <span class="o">=</span> <span class="n">exptime_dark_keyword</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_bias</span> <span class="o">=</span> <span class="n">combinetype_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_bias</span> <span class="o">=</span> <span class="n">sigma_clipping_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_low_bias</span> <span class="o">=</span> <span class="n">clip_low_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_high_bias</span> <span class="o">=</span> <span class="n">clip_high_bias</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_flat</span> <span class="o">=</span> <span class="n">combinetype_flat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_flat</span> <span class="o">=</span> <span class="n">sigma_clipping_flat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_low_flat</span> <span class="o">=</span> <span class="n">clip_low_flat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clip_high_flat</span> <span class="o">=</span> <span class="n">clip_high_flat</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_master</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_filename</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_filename</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># import file with first column as image type and second column as</span>
        <span class="c1"># file path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filelist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelistpath</span><span class="p">,</span>
                                      <span class="n">delimiter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delimiter</span><span class="p">,</span>
                                      <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span>
                                      <span class="n">autostrip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelist</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;bias&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;dark&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;arc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bias_hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;bias&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dark_hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;dark&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flat_hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;arc&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_hdunum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdunum</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imtype</span> <span class="o">==</span> <span class="s1">&#39;light&#39;</span><span class="p">]</span>

        <span class="c1"># If there is no science frames, nothing to process.</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_list</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;There is no light frame.&#39;</span>

        <span class="c1"># Check if all files exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_files</span><span class="p">()</span>

        <span class="c1"># FITS keyword standard for the spectral direction, if FITS header</span>
        <span class="c1"># does not contain SAXIS, the image in assumed to have the spectra</span>
        <span class="c1"># going across (left to right corresponds to blue to red). All frames</span>
        <span class="c1"># get rotated in the anti-clockwise direction if the first light frame</span>
        <span class="c1"># has a verticle spectrum (top to bottom corresponds to blue to red).</span>
        <span class="k">if</span> <span class="n">saxis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">saxis_keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saxis_keyword</span> <span class="o">=</span> <span class="s1">&#39;SAXIS&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saxis_keyword</span> <span class="o">=</span> <span class="n">saxis_keyword</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saxis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">saxis_keyword</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Saxis keyword &quot;&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">saxis_keyword</span> <span class="o">+</span>
                                  <span class="s1">&#39;&quot; is not in the header. Saxis is set to 1.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">saxis</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">saxis</span> <span class="o">=</span> <span class="n">saxis</span>

        <span class="c1"># Only load the science data, other types of image data are loaded by</span>
        <span class="c1"># separate methods.</span>
        <span class="n">light_CCDData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">light_time</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Open all the light frames</span>
            <span class="n">light</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">light_hdunum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">light_CCDData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">light_filename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Get the exposure time for the light frames</span>
            <span class="k">if</span> <span class="n">exptime_light</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exptime_light_keyword</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># add line to check exptime_light_keyword is string</span>
                    <span class="n">light_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">exptime_light_keyword</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># check if the exposure time keyword exists</span>
                    <span class="n">exptime_keyword_matched</span> <span class="o">=</span>\
                    <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_keyword</span><span class="p">,</span> <span class="n">light</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exptime_keyword_matched</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">light_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">light</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_keyword</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">exptime_keyword_matched</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">(</span><span class="n">exptime_light</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;Exposure time has to be positive.&#39;</span>
                <span class="n">light_time</span> <span class="o">=</span> <span class="n">exptime_light</span>

        <span class="c1"># Put data into a Combiner</span>
        <span class="n">light_combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">light_CCDData</span><span class="p">)</span>
        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">light_CCDData</span>

        <span class="c1"># Apply sigma clipping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_light</span><span class="p">:</span>
            <span class="n">light_combiner</span><span class="o">.</span><span class="n">sigma_clipping</span><span class="p">(</span><span class="n">low_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_light</span><span class="p">,</span>
                                          <span class="n">high_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_light</span><span class="p">,</span>
                                          <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

        <span class="c1"># Image combine by median or average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_light</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="n">light_combiner</span><span class="o">.</span><span class="n">median_combine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_light</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">light_time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_light</span> <span class="o">==</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="n">light_combiner</span><span class="o">.</span><span class="n">average_combine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_light</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">light_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ASPIRED: Unknown combinetype.&#39;</span><span class="p">)</span>

        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">light_combiner</span>

        <span class="c1"># If exposure time cannot be found from the header and user failed</span>
        <span class="c1"># to supply the exposure time, use 1 second</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">light_time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">light_time</span> <span class="o">=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Light frame exposure time cannot be found. &#39;</span>
                              <span class="s1">&#39;1 second is used as the exposure time.&#39;</span><span class="p">)</span>

        <span class="c1"># Combine the arcs</span>
        <span class="n">arc_CCDData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Open all the light frames</span>
            <span class="n">arc</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_hdunum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">arc_CCDData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">arc</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">arc_filename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># combine the arc frames</span>
        <span class="n">arc_combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">arc_CCDData</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc_master</span> <span class="o">=</span> <span class="n">arc_combiner</span><span class="o">.</span><span class="n">median_combine</span><span class="p">()</span>

        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">arc_CCDData</span>
        <span class="k">del</span> <span class="n">arc_combiner</span>

<div class="viewcode-block" id="ImageReduction._check_files"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction._check_files">[docs]</a>    <span class="k">def</span> <span class="nf">_check_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impath</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File &#39;</span> <span class="o">+</span> <span class="n">filepath</span> <span class="o">+</span> <span class="s1">&#39; does not exist.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageReduction._bias_subtract"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction._bias_subtract">[docs]</a>    <span class="k">def</span> <span class="nf">_bias_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">combinetype</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                       <span class="n">sigma_clipping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">clip_low</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">clip_high</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform bias subtraction if bias frames are available.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">bias_CCDData</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Open all the bias frames</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_hdunum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">bias_CCDData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">bias</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Put data into a Combiner</span>
        <span class="n">bias_combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">bias_CCDData</span><span class="p">)</span>

        <span class="c1"># Apply sigma clipping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_bias</span><span class="p">:</span>
            <span class="n">bias_combiner</span><span class="o">.</span><span class="n">sigma_clipping</span><span class="p">(</span><span class="n">low_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_bias</span><span class="p">,</span>
                                         <span class="n">high_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_bias</span><span class="p">,</span>
                                         <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

        <span class="c1"># Image combine by median or average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_bias</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biascombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias_master</span> <span class="o">=</span> <span class="n">bias_combiner</span><span class="o">.</span><span class="n">median_combine</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_bias</span> <span class="o">==</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">biascombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias_master</span> <span class="o">=</span> <span class="n">bias_combiner</span><span class="o">.</span><span class="n">average_combine</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ASPIRED: Unknown combinetype.&#39;</span><span class="p">)</span>

        <span class="c1"># Bias subtract</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_master</span><span class="p">)</span>

        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">bias_CCDData</span>
        <span class="k">del</span> <span class="n">bias_combiner</span></div>

<div class="viewcode-block" id="ImageReduction._dark_subtract"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction._dark_subtract">[docs]</a>    <span class="k">def</span> <span class="nf">_dark_subtract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">combinetype</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span>
                       <span class="n">sigma_clipping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">clip_low</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                       <span class="n">clip_high</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform dark subtraction if dark frames are available</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">dark_CCDData</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dark_time</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Open all the dark frames</span>
            <span class="n">dark</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_hdunum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">dark_CCDData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">dark</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Get the exposure time for the dark frames</span>
            <span class="k">for</span> <span class="n">exptime</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime_keyword</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dark_time</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dark</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">exptime</span><span class="p">])</span>
                    <span class="k">break</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

        <span class="c1"># Put data into a Combiner</span>
        <span class="n">dark_combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">dark_CCDData</span><span class="p">)</span>

        <span class="c1"># Apply sigma clipping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_dark</span><span class="p">:</span>
            <span class="n">dark_combiner</span><span class="o">.</span><span class="n">sigma_clipping</span><span class="p">(</span><span class="n">low_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_dark</span><span class="p">,</span>
                                         <span class="n">high_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_dark</span><span class="p">,</span>
                                         <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>
        <span class="c1"># Image combine by median or average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_dark</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">darkcombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark_master</span> <span class="o">=</span> <span class="n">dark_combiner</span><span class="o">.</span><span class="n">median_combine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dark_time</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_dark</span> <span class="o">==</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">darkcombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark_master</span> <span class="o">=</span> <span class="n">dark_combiner</span><span class="o">.</span><span class="n">average_combine</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dark_time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ASPIRED: Unknown combinetype.&#39;</span><span class="p">)</span>

        <span class="c1"># If exposure time cannot be found from the header, use 1 second</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dark_time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Dark frame exposure time cannot be found. &#39;</span>
                              <span class="s1">&#39;1 second is used as the exposure time.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="c1"># Frame in unit of ADU per second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span>\
            <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dark_master</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">exptime_light</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">dark_CCDData</span>
        <span class="k">del</span> <span class="n">dark_combiner</span></div>

<div class="viewcode-block" id="ImageReduction._flatfield"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction._flatfield">[docs]</a>    <span class="k">def</span> <span class="nf">_flatfield</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform field flattening if flat frames are available</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">flat_CCDData</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1"># Open all the flatfield frames</span>
            <span class="n">flat</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span><span class="p">[</span><span class="n">i</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_hdunum</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">flat_CCDData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CCDData</span><span class="p">(</span><span class="n">flat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">adu</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Put data into a Combiner</span>
        <span class="n">flat_combiner</span> <span class="o">=</span> <span class="n">Combiner</span><span class="p">(</span><span class="n">flat_CCDData</span><span class="p">)</span>

        <span class="c1"># Apply sigma clipping</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_flat</span><span class="p">:</span>
            <span class="n">flat_combiner</span><span class="o">.</span><span class="n">sigma_clipping</span><span class="p">(</span><span class="n">low_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_flat</span><span class="p">,</span>
                                         <span class="n">high_thresh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_flat</span><span class="p">,</span>
                                         <span class="n">func</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

        <span class="c1"># Image combine by median or average</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_flat</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatcombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flat_master</span> <span class="o">=</span> <span class="n">flat_combiner</span><span class="o">.</span><span class="n">median_combine</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combinetype_flat</span> <span class="o">==</span> <span class="s1">&#39;average&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flatcombinetype</span> <span class="o">=</span> <span class="n">combinetype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flat_master</span> <span class="o">=</span> <span class="n">flat_combiner</span><span class="o">.</span><span class="n">average_combine</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ASPIRED: Unknown combinetype.&#39;</span><span class="p">)</span>

        <span class="c1"># Field-flattening</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_master</span><span class="p">)</span>

        <span class="c1"># Free memory</span>
        <span class="k">del</span> <span class="n">flat_CCDData</span>
        <span class="k">del</span> <span class="n">flat_combiner</span></div>

<div class="viewcode-block" id="ImageReduction.reduce"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction.reduce">[docs]</a>    <span class="k">def</span> <span class="nf">reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Perform data reduction using the frames provided.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Bias subtraction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_list</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bias_subtract</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No bias frames. Bias subtraction is not &#39;</span>
                              <span class="s1">&#39;performed.&#39;</span><span class="p">)</span>

        <span class="c1"># Dark subtraction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dark_list</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dark_subtract</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No dark frames. Dark subtraction is not &#39;</span>
                              <span class="s1">&#39;performed.&#39;</span><span class="p">)</span>

        <span class="c1"># Field flattening</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flat_list</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flatfield</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No flat frames. Field-flattening is not &#39;</span>
                              <span class="s1">&#39;performed.&#39;</span><span class="p">)</span>

        <span class="c1"># rotate the frame by 90 degrees anti-clockwise if Saxis is 0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saxis</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="p">)</span>

        <span class="c1"># Construct a FITS object of the reduced frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">light_master</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageReduction.savefits"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction.savefits">[docs]</a>    <span class="k">def</span> <span class="nf">savefits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="s1">&#39;reduced_image.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Save the reduced image to disk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: String</span>
<span class="sd">            Disk location to be written to. Default is at where the Python</span>
<span class="sd">            process/subprocess is execuated.</span>
<span class="sd">        overwrite: tuple</span>
<span class="sd">            Default is False. </span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Put the reduced data in FITS format with a primary header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="p">)</span>

        <span class="c1"># Add the names of all the light frames to header</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_filename</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;light&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">light_filename</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Light frames&#39;</span><span class="p">)</span>

        <span class="c1"># Add the names of all the biad frames to header</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;bias&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bias_filename</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Bias frames&#39;</span><span class="p">)</span>

        <span class="c1"># Add the names of all the dark frames to header</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;dark&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dark_filename</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Dark frames&#39;</span><span class="p">)</span>

        <span class="c1"># Add the names of all the flat frames to header</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;flat&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                          <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flat_filename</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Flat frames&#39;</span><span class="p">)</span>

        <span class="c1"># Add all the other keywords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;FILELIST&#39;</span><span class="p">,</span>
                                  <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filelistpath</span><span class="p">,</span>
                                  <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;File location of the frames used.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LCOMTYPE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combinetype_light</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Type of image combine of the light frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LSIGCLIP&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_light</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;True if the light frames are sigma clipped.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LCLIPLOW&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_light</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lower threshold of sigma clipping of the light frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LCLIPHIG&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_light</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Higher threshold of sigma clipping of the light frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LXPOSURE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_light</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Average exposure time of the light frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;LKEYWORD&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_light_keyword</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Automatically identified exposure time keyword of the &#39;</span>
                    <span class="s1">&#39;light frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DCOMTYPE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combinetype_dark</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Type of image combine of the dark frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DSIGCLIP&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_dark</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;True if the dark frames are sigma clipped.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DCLIPLOW&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_dark</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lower threshold of sigma clipping of the dark frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DCLIPHIG&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_dark</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Higher threshold of sigma clipping of the dark frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DXPOSURE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Average exposure time of the dark frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;DKEYWORD&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exptime_dark_keyword</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Automatically identified exposure time keyword of the &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;dark frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;BCOMTYPE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combinetype_bias</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Type of image combine of the bias frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;BSIGCLIP&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_bias</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;True if the dark frames are sigma clipped.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;BCLIPLOW&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_bias</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lower threshold of sigma clipping of the bias frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;BCLIPHIG&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_bias</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Higher threshold of sigma clipping of the bias frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;FCOMTYPE&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">combinetype_flat</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Type of image combine of the flat frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;FSIGCLIP&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sigma_clipping_flat</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;True if the flat frames are sigma clipped.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;FCLIPLOW&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_low_flat</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Lower threshold of sigma clipping of the flat frames.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;FCLIPHIG&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clip_high_flat</span><span class="p">,</span>
            <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Higher threshold of sigma clipping of the flat frames.&#39;</span><span class="p">)</span>

        <span class="c1"># Save file to disk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fits_data</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageReduction.inspect"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction.inspect">[docs]</a>    <span class="k">def</span> <span class="nf">inspect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Display the reduced image with a supported plotly renderer or export</span>
<span class="sd">        as json strings.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        log: tuple</span>
<span class="sd">            Log the ADU count per second in the display. Default is True.</span>
<span class="sd">        renderer: string</span>
<span class="sd">            plotly renderer: jpg, png</span>
<span class="sd">        jsonstring: tuple</span>
<span class="sd">            set to True to return json string that can be rendered by Plot.ly</span>
<span class="sd">            in any support language</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        json string if jsonstring is True, otherwise only an image is displayed</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">plotly_imported</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">log</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="p">),</span>
                                                <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">light_master</span><span class="p">,</span> <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;plotly is not present, diagnostic plots cannot &#39;</span></div>
                              <span class="s1">&#39;be generated.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="ImageReduction.list_files"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.ImageReduction.list_files">[docs]</a>    <span class="k">def</span> <span class="nf">list_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Print the file input list.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filelist</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TwoDSpec"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec">[docs]</a><span class="k">class</span> <span class="nc">TwoDSpec</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">img</span><span class="p">,</span>
                 <span class="n">Saxis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">spatial_mask</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span>
                 <span class="n">spec_mask</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">),</span>
                 <span class="n">flip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">cr</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">cr_sigma</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                 <span class="n">rn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gain</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">seeing</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">exptime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">silence</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Currently, there is no automated way to decide if a flip is needed.</span>

<span class="sd">        The supplied file should contain 2 or 3 columns with the following</span>
<span class="sd">        structure:</span>

<span class="sd">            column 1: one of bias, dark, flat or light</span>
<span class="sd">            column 2: file location</span>
<span class="sd">            column 3: HDU number (default to 0 if not given)</span>

<span class="sd">        If the 2D spectrum is</span>
<span class="sd">        +--------+--------+-------+-------+</span>
<span class="sd">        |  blue  |   red  | Saxis |  flip |</span>
<span class="sd">        +--------+--------+-------+-------+</span>
<span class="sd">        |  left  |  right |   1   | False |</span>
<span class="sd">        |  right |  left  |   1   |  True |</span>
<span class="sd">        |   top  | bottom |   0   | False |</span>
<span class="sd">        | bottom |   top  |   0   |  True |</span>
<span class="sd">        +--------+--------+-------+-------+</span>

<span class="sd">        Spectra are sorted by their brightness. If there are multiple spectra</span>
<span class="sd">        on the image, and the target is not the brightest source, use at least</span>
<span class="sd">        the number of spectra visible to eye and pick the one required later.</span>
<span class="sd">        The default automated outputs is the brightest one, which is the</span>
<span class="sd">        most common case for images from a long-slit spectrograph.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        img: 2D numpy array (M x N)</span>
<span class="sd">            2D spectral image</span>
<span class="sd">        Saxis: int, optional</span>
<span class="sd">            Spectral direction, 0 for vertical, 1 for horizontal.</span>
<span class="sd">            (Default is 1)</span>
<span class="sd">        spatial_mask: 1D numpy array (N), optional</span>
<span class="sd">            Mask in the spatial direction, can be the indices of the pixels</span>
<span class="sd">            to be included (size &lt;N) or a 1D numpy array of True/False (size N)</span>
<span class="sd">            (Default is (1,) i.e. keep everything)</span>
<span class="sd">        spec_mask: 1D numpy array (M), optional</span>
<span class="sd">            Mask in the spectral direction, can be the indices of the pixels</span>
<span class="sd">            to be included (size &lt;M) or a 1D numpy array of True/False (size M)</span>
<span class="sd">            (Default is (1,) i.e. keep everything)</span>
<span class="sd">        flip: tuple, optional</span>
<span class="sd">            If the frame has to be left-right flipped, set to True.</span>
<span class="sd">            (Deafult is False)</span>
<span class="sd">        cr: tuple, optional</span>
<span class="sd">            Set to True to apply cosmic ray rejection by sigma clipping with</span>
<span class="sd">            astroscrappy if available, otherwise a 2D median filter of size 5</span>
<span class="sd">            would be used. (default is True)</span>
<span class="sd">        cr_sigma: float, optional</span>
<span class="sd">            Cosmic ray sigma clipping limit (Deafult is 5.0)</span>
<span class="sd">        rn: float, optional</span>
<span class="sd">            Readnoise of the detector, not important if noise estimation is</span>
<span class="sd">            not needed.</span>
<span class="sd">            (Deafult is None, which will be replaced with 1.0)</span>
<span class="sd">        gain: float, optional</span>
<span class="sd">            Gain of the detector, not important if noise estimation is</span>
<span class="sd">            not needed.</span>
<span class="sd">            (Deafult is None, which will be replaced with 1.0)</span>
<span class="sd">        seeing: float, optional</span>
<span class="sd">            Seeing in unit of arcsec, use as the first guess of the line</span>
<span class="sd">            spread function of the spectra.</span>
<span class="sd">            (Deafult is None, which will be replaced with 1.0)</span>
<span class="sd">        exptime: float, optional</span>
<span class="sd">            Esposure time for the observation, not important if absolute flux</span>
<span class="sd">            calibration is not needed.</span>
<span class="sd">            (Deafult is None, which will be replaced with 1.0)</span>
<span class="sd">        silence: tuple, optional</span>
<span class="sd">            Set to True to suppress all verbose output.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="o">=</span> <span class="n">Saxis</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Waxis</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Waxis</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_mask</span> <span class="o">=</span> <span class="n">spatial_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_mask</span> <span class="o">=</span> <span class="n">spec_mask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flip</span> <span class="o">=</span> <span class="n">flip</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cr_sigma</span> <span class="o">=</span> <span class="n">cr_sigma</span>
        <span class="k">if</span> <span class="n">rn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rn</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rn</span> <span class="o">=</span> <span class="n">rn</span>
        <span class="k">if</span> <span class="n">gain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">=</span> <span class="n">gain</span>
        <span class="k">if</span> <span class="n">seeing</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seeing</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seeing</span> <span class="o">=</span> <span class="n">seeing</span>
        <span class="k">if</span> <span class="n">exptime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">exptime</span>

        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>

        <span class="c1"># cosmic ray rejection</span>
        <span class="k">if</span> <span class="n">cr</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">detect_cosmics</span><span class="p">(</span><span class="n">img</span><span class="p">,</span>
                                 <span class="n">sigclip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cr_sigma</span><span class="p">,</span>
                                 <span class="n">readnoise</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rn</span><span class="p">,</span>
                                 <span class="n">gain</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gain</span><span class="p">,</span>
                                 <span class="n">fsmode</span><span class="o">=</span><span class="s1">&#39;convolve&#39;</span><span class="p">,</span>
                                 <span class="n">psffwhm</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seeing</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># the valid y-range of the chip (i.e. spatial direction)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">]</span>

        <span class="c1"># the valid x-range of the chip (i.e. spectral direction)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">]</span>

        <span class="c1"># get the length in the spectral and spatial directions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">Waxis</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">img</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">img</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">flip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>

        <span class="c1"># set the 2D histogram z-limits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">),</span> <span class="mi">95</span><span class="p">)</span>

<div class="viewcode-block" id="TwoDSpec._gaus"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec._gaus">[docs]</a>    <span class="k">def</span> <span class="nf">_gaus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simple Gaussian function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x: float or 1-d numpy array</span>
<span class="sd">            The data to evaluate the Gaussian over</span>
<span class="sd">        a: float</span>
<span class="sd">            the amplitude</span>
<span class="sd">        b: float</span>
<span class="sd">            the constant offset</span>
<span class="sd">        x0: float</span>
<span class="sd">            the center of the Gaussian</span>
<span class="sd">        sigma: float</span>
<span class="sd">            the width of the Gaussian</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Array or float of same type as input (x).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="n">b</span></div>

<div class="viewcode-block" id="TwoDSpec._identify_spectra"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec._identify_spectra">[docs]</a>    <span class="k">def</span> <span class="nf">_identify_spectra</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_height</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span> <span class="n">jsonstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identify peaks assuming the spatial and spectral directions are</span>
<span class="sd">        aligned with the X and Y direction within a few degrees.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        f_height: float</span>
<span class="sd">            The minimum intensity as a fraction of maximum height.</span>
<span class="sd">        display: tuple</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        peaks_y :</span>
<span class="sd">            Array or float of the pixel values of the detected peaks</span>
<span class="sd">        heights_y :</span>
<span class="sd">            Array or float of the integrated counts at the peaks </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_size</span><span class="p">)</span>
        <span class="n">ztot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span><span class="p">)</span>

        <span class="c1"># get the height thershold</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ztot</span><span class="p">)</span> <span class="o">*</span> <span class="n">f_height</span>

        <span class="c1"># identify peaks</span>
        <span class="n">peaks_y</span><span class="p">,</span> <span class="n">heights_y</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">ztot</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="n">heights_y</span> <span class="o">=</span> <span class="n">heights_y</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span>

        <span class="c1"># sort by strength</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">heights_y</span><span class="p">)</span>
        <span class="n">peaks_y</span> <span class="o">=</span> <span class="n">peaks_y</span><span class="p">[</span><span class="n">mask</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">heights_y</span> <span class="o">=</span> <span class="n">heights_y</span><span class="p">[</span><span class="n">mask</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># display disgnostic plot</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="c1"># set a side-by-side subplot</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

            <span class="c1"># show the image on the left</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Saxis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">),</span>
                               <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)),</span>
                               <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">))</span>

            <span class="c1"># plot the integrated count and the detected peaks on the right</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ztot</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                           <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">heights_y</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">ydata</span><span class="p">[</span><span class="n">peaks_y</span><span class="p">],</span>
                           <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                           <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">,</span>
                              <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                         <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectral Direction / pixel&#39;</span><span class="p">),</span>
                              <span class="n">xaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                          <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Integrated Count&#39;</span><span class="p">),</span>
                              <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                              <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peak</span> <span class="o">=</span> <span class="n">peaks_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span> <span class="o">=</span> <span class="n">heights_y</span></div>

<div class="viewcode-block" id="TwoDSpec._optimal_signal"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec._optimal_signal">[docs]</a>    <span class="k">def</span> <span class="nf">_optimal_signal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pix</span><span class="p">,</span> <span class="n">xslice</span><span class="p">,</span> <span class="n">sky</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">display</span><span class="p">,</span> <span class="n">renderer</span><span class="p">,</span>
                        <span class="n">jsonstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterate to get optimal signal, for internal use only</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pix: 1-d numpy array</span>
<span class="sd">            pixel number along the spatial direction</span>
<span class="sd">        xslice: 1-d numpy array</span>
<span class="sd">            ADU along the pix</span>
<span class="sd">        sky: 1-d numpy array</span>
<span class="sd">            ADU of the fitted sky along the pix</span>
<span class="sd">        mu: float</span>
<span class="sd">            The center of the Gaussian</span>
<span class="sd">        sigma: float</span>
<span class="sd">            The width of the Gaussian</span>
<span class="sd">        display: tuple</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        signal: float</span>
<span class="sd">            The optimal signal. </span>
<span class="sd">        noise: float</span>
<span class="sd">            The noise associated with the optimal signal.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># construct the Gaussian model</span>
        <span class="n">P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">P</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">xslice</span> <span class="o">-</span> <span class="n">sky</span>
        <span class="n">signal</span><span class="p">[</span><span class="n">signal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># weight function and initial values</span>
        <span class="n">signal1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rn</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xslice</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span>
        <span class="n">variance1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">P</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">var1</span><span class="p">)</span>

        <span class="n">signal_diff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">variance_diff</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="p">((</span><span class="n">signal_diff</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">variance_diff</span> <span class="o">&gt;</span> <span class="mf">0.0001</span><span class="p">)):</span>

            <span class="n">signal0</span> <span class="o">=</span> <span class="n">signal1</span>
            <span class="n">var0</span> <span class="o">=</span> <span class="n">var1</span>
            <span class="n">variance0</span> <span class="o">=</span> <span class="n">variance1</span>

            <span class="c1"># cosmic ray mask, only start considering after the 2nd iteration</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mask_cr</span> <span class="o">=</span> <span class="p">((</span><span class="n">signal</span> <span class="o">-</span> <span class="n">P</span> <span class="o">*</span> <span class="n">signal0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">&lt;</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">cr_sigma</span><span class="o">**</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">var0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mask_cr</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># compute signal and noise</span>
            <span class="n">signal1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">P</span> <span class="o">*</span> <span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">/</span> <span class="n">var0</span><span class="p">)[</span><span class="n">mask_cr</span><span class="p">])</span> <span class="o">/</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">P</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">var0</span><span class="p">)[</span><span class="n">mask_cr</span><span class="p">])</span>
            <span class="n">var1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rn</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">P</span> <span class="o">*</span> <span class="n">signal1</span> <span class="o">+</span> <span class="n">sky</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span>
            <span class="n">variance1</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">((</span><span class="n">P</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">var1</span><span class="p">)[</span><span class="n">mask_cr</span><span class="p">])</span>

            <span class="n">signal_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">signal1</span> <span class="o">-</span> <span class="n">signal0</span><span class="p">)</span> <span class="o">/</span> <span class="n">signal0</span>
            <span class="n">variance_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">variance1</span> <span class="o">-</span> <span class="n">variance0</span><span class="p">)</span> <span class="o">/</span> <span class="n">variance0</span>

            <span class="n">P</span> <span class="o">=</span> <span class="n">signal</span> <span class="o">/</span> <span class="n">signal1</span>
            <span class="n">P</span><span class="p">[</span><span class="n">P</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">P</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">P</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">999</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;Unable to obtain optimal signal, please try a longer &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;iteration or revert to unit-weighted extraction. Values &#39;</span>
                    <span class="o">+</span> <span class="s1">&#39;returned (if at all) are sub-optimal at best.&#39;</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="n">signal</span> <span class="o">=</span> <span class="n">signal1</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">signal</span><span class="p">),</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">+</span> <span class="n">sky</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">xslice</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pix</span><span class="p">,</span> <span class="n">fit</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Pixel&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Count&#39;</span><span class="p">)</span>
            <span class="c1">#print(signal, variance)</span>
            <span class="c1">#print(np.sum(xslice-sky_const))</span>

        <span class="k">return</span> <span class="n">signal</span><span class="p">,</span> <span class="n">noise</span></div>

<div class="viewcode-block" id="TwoDSpec.ap_trace"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec.ap_trace">[docs]</a>    <span class="k">def</span> <span class="nf">ap_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">nspec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">nwindow</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
                 <span class="n">spec_sep</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">resample_factor</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">scaling_min</span><span class="o">=</span><span class="mf">0.975</span><span class="p">,</span>
                 <span class="n">scaling_max</span><span class="o">=</span><span class="mf">1.025</span><span class="p">,</span>
                 <span class="n">scaling_step</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
                 <span class="n">p_bg</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                 <span class="n">tol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                 <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                 <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">                trace: 1-d numpy array (N)</span>
<span class="sd">            The spatial positions (Y axis) corresponding to the center of the</span>
<span class="sd">            trace for every wavelength (X axis), as returned from ap_trace</span>
<span class="sd">        trace_sigma: float, or 1-d array (1 or N)</span>
<span class="sd">            Tophat extraction: Float is accepted but will be rounded to an int,</span>
<span class="sd">                                which gives the constant aperture size on either</span>
<span class="sd">                                side of the trace to extract.</span>
<span class="sd">            Optimal extraction: Float or 1-d array of the same size as the trace.</span>
<span class="sd">                                If a float is supplied, a fixed standard deviation</span>
<span class="sd">                                will be used to construct the gaussian weight</span>
<span class="sd">                                function along the entire spectrum.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nspec: int, optional</span>

<span class="sd">        nwindow: int, optional</span>

<span class="sd">        spec_sep: int, optional</span>

<span class="sd">        resample_factor: int, optional</span>

<span class="sd">        rescale: tuple, optional</span>

<span class="sd">        scaling_min: float, optional</span>

<span class="sd">        scaling_max: float, optional</span>

<span class="sd">        scaling_step: float, optional</span>

<span class="sd">        p_bg: float, optional</span>

<span class="sd">        tol: float, optional</span>

<span class="sd">        display: tuple, optional</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string, optional</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple, optional</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get the shape of the 2D spectrum and define upsampling ratio</span>
        <span class="n">nwave</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nspatial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">)</span>

        <span class="n">nresample</span> <span class="o">=</span> <span class="n">nspatial</span> <span class="o">*</span> <span class="n">resample_factor</span>

        <span class="c1"># window size</span>
        <span class="n">w_size</span> <span class="o">=</span> <span class="n">nwave</span> <span class="o">//</span> <span class="n">nwindow</span>
        <span class="n">img_split</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">nwindow</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">lines_ref_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">img_split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lines_ref_init_resampled</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">lines_ref_init</span><span class="p">,</span> <span class="n">nresample</span><span class="p">)</span>

        <span class="c1"># linear scaling limits</span>
        <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
            <span class="n">scaling_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">scaling_min</span><span class="p">,</span> <span class="n">scaling_max</span><span class="p">,</span> <span class="n">scaling_step</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scaling_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># estimate the 5-th percentile as the sky background level</span>
        <span class="n">lines_ref</span> <span class="o">=</span> <span class="n">lines_ref_init_resampled</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
            <span class="n">lines_ref_init_resampled</span><span class="p">,</span> <span class="n">p_bg</span><span class="p">)</span>

        <span class="n">shift_solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nwindow</span><span class="p">)</span>
        <span class="n">scale_solution</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">nwindow</span><span class="p">)</span>

        <span class="c1"># maximum shift (SEMI-AMPLITUDE) from the neighbour (pixel)</span>
        <span class="n">tol_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tol</span> <span class="o">*</span> <span class="n">resample_factor</span><span class="p">)</span>

        <span class="c1"># Scipy correlate method</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwindow</span><span class="p">):</span>

            <span class="c1"># smooth by taking the median</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">img_split</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">nresample</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">p_bg</span><span class="p">)</span>

            <span class="c1"># cross-correlation values and indices</span>
            <span class="n">corr_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaling_range</span><span class="p">))</span>
            <span class="n">corr_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">scaling_range</span><span class="p">))</span>

            <span class="c1"># upsample by the same amount as the reference</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">scale</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scaling_range</span><span class="p">):</span>

                <span class="c1"># Upsampling the reference lines</span>
                <span class="n">lines_ref_j</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">lines_ref</span><span class="p">,</span>
                                              <span class="nb">int</span><span class="p">(</span><span class="n">nresample</span> <span class="o">*</span> <span class="n">scale</span><span class="p">))</span>

                <span class="c1"># find the linear shift</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">lines_ref_j</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>

                <span class="c1"># only consider the defined range of shift tolerance</span>
                <span class="n">corr</span> <span class="o">=</span> <span class="n">corr</span><span class="p">[</span><span class="n">nresample</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tol_len</span><span class="p">:</span><span class="n">nresample</span> <span class="o">+</span> <span class="n">tol_len</span><span class="p">]</span>

                <span class="c1"># Maximum corr position is the shift</span>
                <span class="n">corr_val</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
                <span class="n">corr_idx</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">-</span> <span class="n">tol_len</span>

            <span class="c1"># Maximum corr_val position is the scaling</span>
            <span class="n">shift_solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_idx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">corr_val</span><span class="p">)]</span>
            <span class="n">scale_solution</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaling_range</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">corr_val</span><span class="p">)]</span>

            <span class="c1"># Update (increment) the reference line</span>
            <span class="n">lines_ref</span> <span class="o">=</span> <span class="n">lines</span>

        <span class="n">nscaled</span> <span class="o">=</span> <span class="p">(</span><span class="n">nresample</span> <span class="o">*</span> <span class="n">scale_solution</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

        <span class="c1"># Find the spectral position in the middle of the gram in the upsampled pixel location location</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">img_split</span><span class="p">[</span><span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nresample</span><span class="p">),</span>
                                  <span class="n">distance</span><span class="o">=</span><span class="n">spec_sep</span><span class="p">,</span>
                                  <span class="n">prominence</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># update the number of spectra if the number of peaks detected is less</span>
        <span class="c1"># than the number requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks</span><span class="p">),</span> <span class="n">nspec</span><span class="p">)</span>

        <span class="c1"># Sort the positions by the prominences, and return to the original scale (i.e. with subpixel position)</span>
        <span class="n">spec_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;prominences&#39;</span><span class="p">])]</span>
                            <span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">])</span> <span class="o">/</span> <span class="n">resample_factor</span>

        <span class="c1"># Create array to populate the spectral locations</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">spec_init</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_split</span><span class="p">)))</span>
        <span class="c1">#spec_val = np.zeros((len(spec_init), len(img_split)))</span>

        <span class="c1"># Populate the initial values</span>
        <span class="n">spec</span><span class="p">[:,</span> <span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec_init</span>

        <span class="c1"># Pixel positions of the mid point of each data_split</span>
        <span class="n">spec_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_split</span><span class="p">))</span> <span class="o">*</span> <span class="n">w_size</span> <span class="o">+</span> <span class="n">w_size</span> <span class="o">/</span> <span class="mf">2.</span>

        <span class="c1"># Looping through pixels larger than middle pixel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_split</span><span class="p">)):</span>
            <span class="n">spec</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">resample_factor</span> <span class="o">*</span> <span class="n">nscaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                          <span class="n">nresample</span> <span class="o">-</span> <span class="n">shift_solution</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="n">resample_factor</span>

        <span class="c1"># Looping through pixels smaller than middle pixel</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">spec</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">resample_factor</span> <span class="o">+</span>
                          <span class="n">shift_solution</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                              <span class="nb">int</span><span class="p">(</span><span class="n">nresample</span> <span class="o">*</span> <span class="n">scale_solution</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span>
                              <span class="n">nresample</span><span class="p">)</span> <span class="o">/</span> <span class="n">resample_factor</span>
            <span class="c1">#spec_val[:,i] = signal.resample(np.nanmedian(img_split[i], axis=0), int(nresample*scale_solution[i]))[(spec[:,i] * scale_solution[i]).astype(&#39;int&#39;)]</span>

        <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">nwave</span><span class="p">))</span>
        <span class="n">ap_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">),</span> <span class="n">nwave</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)):</span>
            <span class="c1"># fit the trace</span>
            <span class="n">ap_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">spec_pix</span><span class="p">,</span> <span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nwindow</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">ap_p</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nwave</span><span class="p">))</span>

            <span class="c1"># stacking up the slices to get a good guess of the LSF</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ap_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">spec_pix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)]):</span>
                <span class="n">ap_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">img_split</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Add 0.5 to allow proper rounding</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ap_idx</span> <span class="o">-</span> <span class="mi">20</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ap_spatial</span> <span class="o">=</span> <span class="n">ap_slice</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ap_spatial</span> <span class="o">+=</span> <span class="n">ap_slice</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>

            <span class="c1"># compute ONE sigma for each trace</span>
            <span class="n">pguess</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ap_spatial</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">ap_spatial</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">ap_idx</span><span class="p">,</span> <span class="mf">3.</span>
            <span class="p">]</span>

            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">,</span>
                                   <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">),</span>
                                   <span class="n">ap_spatial</span><span class="p">,</span>
                                   <span class="n">p0</span><span class="o">=</span><span class="n">pguess</span><span class="p">)</span>
            <span class="n">ap_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">ap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_sigma</span> <span class="o">=</span> <span class="n">ap_sigma</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">ap</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_sigma</span> <span class="o">=</span> <span class="n">ap_sigma</span>

        <span class="c1"># Plot</span>
        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>

            <span class="c1"># set a side-by-side subplot</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

            <span class="c1"># show the image on the left</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">),</span>
                           <span class="n">zmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin</span><span class="p">,</span>
                           <span class="n">zmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">,</span>
                           <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                           <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;log(ADU)&#39;</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">)):</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nwave</span><span class="p">),</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spec_pix</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                               <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                               <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">)))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span> <span class="o">*</span> <span class="n">spec_pix</span><span class="p">[</span><span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">spec</span><span class="p">[:,</span> <span class="n">nwindow</span> <span class="o">//</span> <span class="mi">2</span><span class="p">],</span>
                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                           <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">)))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;SpectralDirection / pixel&#39;</span><span class="p">,</span>
                              <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">),</span>
                              <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                              <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                              <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span></div>

<div class="viewcode-block" id="TwoDSpec.ap_trace_quick"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec.ap_trace_quick">[docs]</a>    <span class="k">def</span> <span class="nf">ap_trace_quick</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">nspec</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">nsteps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                       <span class="n">recenter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">prevtrace</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">),</span>
                       <span class="n">fittype</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">,</span>
                       <span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                       <span class="n">bigbox</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                       <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                       <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trace the spectrum aperture in an image. It only works for bright</span>
<span class="sd">        spectra with good wavelength coverage.</span>

<span class="sd">        It works by chopping image up in bins along the wavelength direction,</span>
<span class="sd">        fits a Gaussian for each bin to determine the spatial center of the</span>
<span class="sd">        trace. Finally, draws a cubic spline through the bins.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nspec: int, optional</span>
<span class="sd">            Number of spectra to be extracted. It does not guarantee returning</span>
<span class="sd">            the same number of spectra if fewer can be detected. (Default is 1)</span>
<span class="sd">        nsteps: int, optional</span>
<span class="sd">            Keyword, number of bins in X direction to chop image into. Use</span>
<span class="sd">            fewer bins if ap_trace is having difficulty, such as with faint</span>
<span class="sd">            targets (default is 20, minimum is 4)</span>
<span class="sd">        recenter: bool, optional</span>
<span class="sd">            Set to True to use previous trace, allow small shift in position</span>
<span class="sd">            along the spatial direction. Not doing anything if prevtrace is not</span>
<span class="sd">            supplied. (Default is False)</span>
<span class="sd">        prevtrace: 1-d numpy array, optional</span>
<span class="sd">            Provide first guess or refitting the center with different parameters.</span>
<span class="sd">        fittype: string, optional</span>
<span class="sd">            Set to &#39;spline&#39; or &#39;polynomial&#39;, using</span>
<span class="sd">            scipy.interpolate.UnivariateSpline and numpy.polyfit</span>
<span class="sd">        order: string, optional</span>
<span class="sd">            Degree of the spline or polynomial. Spline must be &lt;= 5.</span>
<span class="sd">            (default is k=3)</span>
<span class="sd">        bigbox: float, optional</span>
<span class="sd">            The number of sigma away from the main aperture to allow to trace</span>
<span class="sd">        silence: tuple, optional</span>
<span class="sd">            Set to disable warning/error messages. (Default is False)</span>
<span class="sd">        display: tuple, optional</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string, optional</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple, optional</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        my: array (N, nspec)</span>
<span class="sd">            The spatial (Y) positions of the trace, interpolated over the</span>
<span class="sd">            entire wavelength (X) axis</span>
<span class="sd">        y_sigma: array (N, nspec)</span>
<span class="sd">            The sigma measured at the nsteps.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="n">nspec</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Tracing Aperture using nsteps=&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsteps</span><span class="p">))</span>

        <span class="c1"># the valid y-range of the chip (an array of int)</span>
        <span class="n">ydata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_size</span><span class="p">)</span>
        <span class="n">ztot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># need at least 3 samples along the trace</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nsteps</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="c1"># detect peaks by summing in the spatial direction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_identify_spectra</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span>
                               <span class="mi">1</span><span class="p">,</span>
                               <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
                               <span class="n">jsonstring</span><span class="o">=</span><span class="n">jsonstring</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="c1"># set a side-by-side subplot</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

            <span class="c1"># show the image on the left</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">),</span>
                           <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                           <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                           <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                           <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;log(ADU)&#39;</span><span class="p">)))</span>

            <span class="c1"># plot the integrated count and the detected peaks on the right</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ztot</span><span class="p">),</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                           <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span><span class="p">),</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">,</span>
                           <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                           <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                           <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">))</span>

        <span class="n">my</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">))</span>
        <span class="n">y_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">))</span>

        <span class="c1"># trace each individual spetrum one by one</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">):</span>

            <span class="n">peak_guess</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peak_height</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">ztot</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">peak</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">2.</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">recenter</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prevtrace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prevtrace</span>
                <span class="n">y_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prevtrace</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">seeing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">my</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trace_sigma</span> <span class="o">=</span> <span class="n">y_sigma</span>
                <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="n">ztot</span><span class="p">[</span><span class="n">ztot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span>
                                      <span class="nb">max</span><span class="p">(</span><span class="n">ztot</span><span class="p">)],</span>
                                   <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
                                      <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">i</span><span class="p">])],</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                   <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                                   <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                   <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x1&#39;</span><span class="p">))</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">,</span>
                                      <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                          <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                          <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                          <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectral Direction / pixel&#39;</span><span class="p">),</span>
                                      <span class="n">xaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                  <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                                  <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Integrated Count&#39;</span><span class="p">),</span>
                                      <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                                      <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

                <span class="k">break</span>

            <span class="c1"># use middle of previous trace as starting guess</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">recenter</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prevtrace</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">):</span>
                <span class="n">peak_guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">prevtrace</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># fit a Gaussian to peak</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pgaus</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">,</span>
                        <span class="n">ydata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ztot</span><span class="p">)],</span>
                        <span class="n">ztot</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">ztot</span><span class="p">)],</span>
                        <span class="n">p0</span><span class="o">=</span><span class="n">peak_guess</span><span class="p">,</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">peak_guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.</span><span class="p">),</span>
                                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">peak_guess</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span>
                    <span class="c1">#print(pgaus, pcov)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                        <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;Spectrum &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; is likely to be (1) too faint, (2) in a crowed&#39;</span>
                            <span class="s1">&#39; field, or (3) an extended source. Automated&#39;</span> <span class="o">+</span>
                            <span class="s1">&#39; tracing is sub-optimal. Please (1) reduce nspec,&#39;</span>
                            <span class="o">+</span> <span class="s1">&#39; (2) reduce n_steps, or (3) provide prevtrace.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">(</span><span class="n">ydata</span><span class="p">,</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                       <span class="n">pgaus</span><span class="p">[</span><span class="mi">3</span><span class="p">])),</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">ydata</span><span class="p">,</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                   <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">))</span>

                <span class="c1"># only allow data within a box around this peak</span>
                <span class="n">ydata2</span> <span class="o">=</span> <span class="n">ydata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">ydata</span> <span class="o">&gt;=</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">bigbox</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">ydata</span> <span class="o">&lt;=</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">bigbox</span><span class="p">))]</span>
                <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec_size</span><span class="p">)[</span><span class="n">ydata2</span><span class="p">]</span>

                <span class="c1"># define the X-bin edges</span>
                <span class="n">xbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">)</span>
                <span class="n">ybins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xbins</span><span class="p">)</span>
                <span class="n">ybins_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">xbins</span><span class="p">)</span>

                <span class="c1"># loop through each bin</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">xbins</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># fit gaussian w/j each window</span>
                    <span class="n">zi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="n">ydata2</span><span class="p">,</span>
                                         <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">xbins</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                                             <span class="p">):</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">xbins</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))],</span>
                                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># fit gaussian w/j each window</span>
                    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">pguess</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">zi</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">zi</span><span class="p">),</span> <span class="n">yi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">zi</span><span class="p">)],</span> <span class="mf">2.</span>
                        <span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gaus</span><span class="p">,</span> <span class="n">yi</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">pguess</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Step &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of spectrum &#39;</span> <span class="o">+</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="s1">&#39; cannot be fitted.&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="c1"># if the peak is lower than background, sigma is too broad or</span>
                    <span class="c1"># gaussian fits off chip, then use chip-integrated answer</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)):</span>
                        <span class="n">ybins</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgaus</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">popt</span> <span class="o">=</span> <span class="n">pgaus</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                            <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s1">&#39;Step &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nsteps</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; of spectrum &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span>
                                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">)</span> <span class="o">+</span>
                                <span class="s1">&#39; has a poor fit. Initial guess is used instead.&#39;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ybins</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">ybins_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

                <span class="c1"># recenter the bin positions, trim the unused bin off in Y</span>
                <span class="n">mxbins</span> <span class="o">=</span> <span class="p">(</span><span class="n">xbins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">xbins</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.</span>
                <span class="n">mybins</span> <span class="o">=</span> <span class="n">ybins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">fittype</span> <span class="o">==</span> <span class="s1">&#39;spline&#39;</span><span class="p">):</span>
                    <span class="c1"># run a cubic spline thru the bins</span>
                    <span class="n">interpolated</span> <span class="o">=</span> <span class="n">itp</span><span class="o">.</span><span class="n">UnivariateSpline</span><span class="p">(</span><span class="n">mxbins</span><span class="p">,</span>
                                                        <span class="n">mybins</span><span class="p">,</span>
                                                        <span class="n">ext</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                        <span class="n">k</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                    <span class="c1"># interpolate 1 position per column</span>
                    <span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolated</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span><span class="n">fittype</span> <span class="o">==</span> <span class="s1">&#39;polynomial&#39;</span><span class="p">):</span>
                    <span class="c1"># linear fit</span>
                    <span class="n">npfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">mxbins</span><span class="p">,</span> <span class="n">mybins</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
                    <span class="c1"># interpolate 1 position per column</span>
                    <span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">npfit</span><span class="p">,</span> <span class="n">mx</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                        <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s1">&#39;Unknown fitting type, please choose from &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;(1) </span><span class="se">\&#39;</span><span class="s1">spline</span><span class="se">\&#39;</span><span class="s1">; or (2) </span><span class="se">\&#39;</span><span class="s1">polynomial</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

                <span class="c1"># get the uncertainties in the spatial direction along the spectrum</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span>\
                        <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">mxbins</span><span class="p">,</span> <span class="n">ybins_sigma</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">y_sigma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">slope</span> <span class="o">*</span> <span class="n">mx</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">my</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">silence</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ybins_sigma</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s1">&#39;Spectrum &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; of &#39;</span> <span class="o">+</span>
                            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">)</span> <span class="o">+</span>
                            <span class="s1">&#39; is likely to be (1) too faint, (2) in a crowed&#39;</span>
                            <span class="s1">&#39; field, or (3) an extended source. Automated&#39;</span> <span class="o">+</span>
                            <span class="s1">&#39; tracing is sub-optimal. Please disable multi-source&#39;</span>
                            <span class="o">+</span>
                            <span class="s1">&#39; mode and (1) reduce nspec, or (2) reduce n_steps,&#39;</span>
                            <span class="o">+</span>
                            <span class="s1">&#39;  or (3) provide prevtrace, or (4) all of above.&#39;</span><span class="p">)</span>

                    <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Spectrum &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
                               <span class="s1">&#39;: Trace gaussian width = &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ybins_sigma</span><span class="p">)</span> <span class="o">+</span>
                               <span class="s1">&#39; pixels&#39;</span><span class="p">)</span>

            <span class="c1"># add the minimum pixel value from fmask before returning</span>
            <span class="c1">#if len(spatial_mask)&gt;1:</span>
            <span class="c1">#    my += min(spatial_mask)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">trace</span> <span class="o">=</span> <span class="n">my</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trace_sigma</span> <span class="o">=</span> <span class="n">y_sigma</span>

            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">,</span>
                                  <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                      <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                                      <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectral Direction / pixel&#39;</span><span class="p">),</span>
                                  <span class="n">xaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                              <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                              <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Integrated Count&#39;</span><span class="p">),</span>
                                  <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                                  <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span></div>

<div class="viewcode-block" id="TwoDSpec.ap_extract"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.TwoDSpec.ap_extract">[docs]</a>    <span class="k">def</span> <span class="nf">ap_extract</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">apwidth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                   <span class="n">skysep</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">skywidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                   <span class="n">skydeg</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">optimal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                   <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                   <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extract the spectra using the traces, support aperture or optimal</span>
<span class="sd">        extraction. The sky background is fitted in one dimention only. The</span>
<span class="sd">        uncertainty at each pixel is also computed, but it is only meaningful</span>
<span class="sd">        if correct gain, read noise and are provided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        apwidth: int, optional</span>
<span class="sd">        skysep: int, optional</span>
<span class="sd">            The separation in pixels from the aperture to the sky window.</span>
<span class="sd">            (Default is 3)</span>
<span class="sd">        skywidth: int, optional</span>
<span class="sd">            The width in pixels of the sky windows on either side of the</span>
<span class="sd">            aperture. (Default is 7)</span>
<span class="sd">        skydeg: int, optional</span>
<span class="sd">            The polynomial order to fit between the sky windows.</span>
<span class="sd">            (Default is 0, i.e. constant flat sky level)</span>
<span class="sd">        optimal: tuple, optional</span>
<span class="sd">            Set optimal extraction. (Default is True)</span>
<span class="sd">        silence: tuple, optional</span>
<span class="sd">            Set to disable warning/error messages. (Default is False)</span>
<span class="sd">        display: tuple, optional</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string, optional</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple, optional</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        onedspec: 1-d array</span>
<span class="sd">            The summed adu at each column about the trace. Note: is not</span>
<span class="sd">            sky subtracted!</span>
<span class="sd">        skyadu: 1-d array</span>
<span class="sd">            The integrated sky values along each column, suitable for</span>
<span class="sd">            subtracting from the output of ap_extract</span>
<span class="sd">        aduerr: 1-d array</span>
<span class="sd">            the uncertainties of the adu values</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">len_trace</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">skyadu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">))</span>
        <span class="n">aduerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">))</span>
        <span class="n">adu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">):</span>

            <span class="n">median_trace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                <span class="n">itrace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>

                <span class="c1"># first do the aperture adu</span>
                <span class="n">widthup</span> <span class="o">=</span> <span class="n">apwidth</span>
                <span class="n">widthdn</span> <span class="o">=</span> <span class="n">apwidth</span>

                <span class="c1"># fix width if trace is too close to the edge</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">):</span>
                    <span class="n">widthup</span> <span class="o">=</span> <span class="n">spatial_size</span> <span class="o">-</span> <span class="n">itrace</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">widthdn</span> <span class="o">=</span> <span class="n">itrace</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># i.e. starting at pixel row 1</span>

                <span class="c1"># simply add up the total adu around the trace +/- width</span>
                <span class="n">xslice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span><span class="p">:</span><span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">adu_ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xslice</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">skywidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># get the indexes of the sky regions</span>
                    <span class="n">y0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span> <span class="n">skywidth</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">y1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">y2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">)</span>
                    <span class="n">y3</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span> <span class="o">+</span> <span class="n">skywidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">)</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">y3</span><span class="p">))</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">skydeg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="c1"># fit a polynomial to the sky in this column</span>
                        <span class="n">pfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">skydeg</span><span class="p">)</span>
                        <span class="c1"># define the aperture in this column</span>
                        <span class="n">ap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">apwidth</span><span class="p">,</span> <span class="n">itrace</span> <span class="o">+</span> <span class="n">apwidth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="c1"># evaluate the polynomial across the aperture, and sum</span>
                        <span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">ap</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">skydeg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">apwidth</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>

                <span class="c1"># if optimal extraction</span>
                <span class="k">if</span> <span class="n">optimal</span><span class="p">:</span>
                    <span class="n">pix</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span><span class="p">,</span> <span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># Fit the sky background</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">skydeg</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">pix</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sky</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pix</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                    <span class="c1"># Get the optimal signals</span>
                    <span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">aduerr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimal_signal</span><span class="p">(</span>
                        <span class="n">pix</span><span class="p">,</span>
                        <span class="n">xslice</span><span class="p">,</span>
                        <span class="n">sky</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trace</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">trace_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">renderer</span><span class="o">=</span><span class="n">renderer</span><span class="p">,</span>
                        <span class="n">jsonstring</span><span class="o">=</span><span class="n">jsonstring</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#-- finally, compute the error in this pixel</span>
                    <span class="n">sigB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>  <span class="c1"># stddev in the background data</span>
                    <span class="n">nB</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># number of bkgd pixels</span>
                    <span class="n">nA</span> <span class="o">=</span> <span class="n">apwidth</span> <span class="o">*</span> <span class="mf">2.</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># number of aperture pixels</span>

                    <span class="c1"># based on aperture phot err description by F. Masci, Caltech:</span>
                    <span class="c1"># http://wise2.ipac.caltech.edu/staff/fmasci/ApPhotUncert.pdf</span>
                    <span class="n">aduerr</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">adu_ap</span> <span class="o">-</span> <span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]))</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">gain</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">nA</span> <span class="o">+</span> <span class="n">nA</span><span class="o">**</span><span class="mf">2.</span> <span class="o">/</span> <span class="n">nB</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigB</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
                    <span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adu_ap</span> <span class="o">-</span> <span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">display</span><span class="p">:</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
                <span class="n">img_display</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span>
                    <span class="n">img</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span> <span class="n">skywidth</span> <span class="o">-</span>
                            <span class="mi">1</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span> <span class="o">+</span>
                                   <span class="n">skywidth</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="p">:])</span>

                <span class="c1"># show the image on the top</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_trace</span><span class="p">),</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                            <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span> <span class="n">skywidth</span> <span class="o">-</span>
                                <span class="mi">1</span><span class="p">),</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span> <span class="o">+</span> <span class="n">skywidth</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]))),</span>
                        <span class="n">z</span><span class="o">=</span><span class="n">img_display</span><span class="p">,</span>
                        <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                        <span class="n">zmin</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zmin</span><span class="p">,</span>
                        <span class="n">zmax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">zmax</span><span class="p">,</span>
                        <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                        <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                        <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;log(ADU)&#39;</span><span class="p">)))</span>

                <span class="c1"># Middle black box on the image</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="p">[</span>
                            <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">apwidth</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">apwidth</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="p">],</span>
                        <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                        <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                        <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

                <span class="c1"># Lower red box on the image</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">itrace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">y</span><span class="o">=</span><span class="p">[</span>
                                <span class="nb">max</span><span class="p">(</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span>
                                    <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="nb">max</span><span class="p">(</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span>
                                    <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
                                <span class="nb">max</span><span class="p">(</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span>
                                    <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">skywidth</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)),</span>
                                <span class="nb">max</span><span class="p">(</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span>
                                    <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">skywidth</span><span class="p">,</span> <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)),</span>
                                <span class="nb">max</span><span class="p">(</span>
                                    <span class="mi">0</span><span class="p">,</span> <span class="n">median_trace</span> <span class="o">-</span> <span class="n">widthdn</span> <span class="o">-</span> <span class="n">skysep</span> <span class="o">-</span>
                                    <span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                            <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                            <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

                <span class="c1"># Upper red box on the image</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">itrace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_size</span><span class="p">):</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="n">len_trace</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                   <span class="n">y</span><span class="o">=</span><span class="p">[</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">skywidth</span><span class="p">,</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)),</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">+</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">skywidth</span><span class="p">,</span> <span class="p">(</span><span class="n">y3</span> <span class="o">-</span> <span class="n">y2</span><span class="p">)),</span>
                                       <span class="nb">min</span><span class="p">(</span><span class="n">median_trace</span> <span class="o">+</span> <span class="n">widthup</span> <span class="o">+</span> <span class="n">skysep</span><span class="p">,</span>
                                           <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                   <span class="p">],</span>
                                   <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
                                   <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span>
                                   <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                   <span class="n">line_color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                   <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="c1"># plot the SNR</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_trace</span><span class="p">),</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">aduerr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y3&#39;</span><span class="p">,</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;slategrey&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Signal-to-Noise Ratio&#39;</span><span class="p">))</span>

                <span class="c1"># extrated source, sky and uncertainty</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_trace</span><span class="p">),</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sky ADU&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_trace</span><span class="p">),</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">aduerr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Uncertainty&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">len_trace</span><span class="p">),</span>
                               <span class="n">y</span><span class="o">=</span><span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="s1">&#39;x2&#39;</span><span class="p">,</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Target ADU&#39;</span><span class="p">))</span>

                <span class="c1"># Decorative stuff</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
                    <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                    <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                               <span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">),</span>
                    <span class="n">yaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                        <span class="nb">range</span><span class="o">=</span><span class="p">[</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">aduerr</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">adu</span><span class="p">[</span><span class="n">j</span><span class="p">])),</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">skyadu</span><span class="p">[</span><span class="n">j</span><span class="p">])))</span>
                        <span class="p">],</span>
                        <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">domain</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                        <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                        <span class="n">title</span><span class="o">=</span><span class="s1">&#39;log(ADU / Count)&#39;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">yaxis3</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;S/N ratio&#39;</span><span class="p">,</span>
                                <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span>
                                <span class="n">overlaying</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span>
                                <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">),</span>
                    <span class="n">xaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectral Direction / pixel&#39;</span><span class="p">,</span>
                                <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span>
                                <span class="n">matches</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">),</span>
                    <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                            <span class="n">y</span><span class="o">=</span><span class="mf">0.45</span><span class="p">,</span>
                                            <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                            <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                                      <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                      <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                            <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                    <span class="n">bargap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adu</span> <span class="o">=</span> <span class="n">adu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aduerr</span> <span class="o">=</span> <span class="n">aduerr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skyadu</span> <span class="o">=</span> <span class="n">skyadu</span></div></div>


<div class="viewcode-block" id="WavelengthPolyFit"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.WavelengthPolyFit">[docs]</a><span class="k">class</span> <span class="nc">WavelengthPolyFit</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">arc</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        arc: TwoDSpec object of the arc image</span>
<span class="sd">        spec: TwoDSpec object of the science/standard image</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="n">arc</span>

        <span class="c1"># the valid y-range of the chip (i.e. spatial direction)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spatial_mask</span><span class="p">]</span>

        <span class="c1"># the valid x-range of the chip (i.e. spectral direction)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">spec_mask</span><span class="p">]</span>

        <span class="c1"># get the length in the spectral and spatial directions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">Saxis</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">flip</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">)</span>

<div class="viewcode-block" id="WavelengthPolyFit.find_arc_lines"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.WavelengthPolyFit.find_arc_lines">[docs]</a>    <span class="k">def</span> <span class="nf">find_arc_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">percentile</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
                       <span class="n">distance</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                       <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        pixelscale in unit of A/pix</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">trace</span><span class="p">))</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">trace_sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">arc_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trace</span> <span class="o">-</span> <span class="n">width</span> <span class="o">-</span>
                                      <span class="mi">1</span><span class="p">):</span><span class="nb">min</span><span class="p">(</span><span class="n">trace</span> <span class="o">+</span>
                                             <span class="n">width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">peaks</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span>
                                     <span class="n">distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span>
                                     <span class="n">prominence</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">refine_peaks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">window_width</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">display</span> <span class="o">&amp;</span> <span class="n">plotly_imported</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

            <span class="c1"># show the image on the top</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                           <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="p">),</span>
                           <span class="n">colorscale</span><span class="o">=</span><span class="s2">&quot;Viridis&quot;</span><span class="p">,</span>
                           <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;log(ADU)&#39;</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span>
                               <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                               <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)))</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spectral Direction / pixel&#39;</span><span class="p">),</span>
                              <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Spatial Direction / pixel&#39;</span><span class="p">),</span>
                              <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                              <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">height</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthPolyFit.calibrate"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.WavelengthPolyFit.calibrate">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">elements</span><span class="p">,</span>
                  <span class="n">sample_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">min_wave</span><span class="o">=</span><span class="mf">3500.</span><span class="p">,</span>
                  <span class="n">max_wave</span><span class="o">=</span><span class="mf">8500.</span><span class="p">,</span>
                  <span class="n">max_tries</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span>
                  <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">num_slopes</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                  <span class="n">range_tolerance</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                  <span class="n">fit_tolerance</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
                  <span class="n">polydeg</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                  <span class="n">top_n</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                  <span class="n">candidate_thresh</span><span class="o">=</span><span class="mf">15.</span><span class="p">,</span>
                  <span class="n">ransac_thresh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">xbins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">ybins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                  <span class="n">brute_force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">fittype</span><span class="o">=</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span>
                  <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span>
                  <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                  <span class="n">coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        thresh (A) :: the individual line fitting tolerance to accept as a valid fitting point</span>
<span class="sd">        fit_tolerance (A) :: the RMS</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Calibrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">,</span>
                       <span class="n">min_wavelength</span><span class="o">=</span><span class="n">min_wave</span><span class="p">,</span>
                       <span class="n">max_wavelength</span><span class="o">=</span><span class="n">max_wave</span><span class="p">,</span>
                       <span class="n">num_pixels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">))</span>

        <span class="n">c</span><span class="o">.</span><span class="n">add_atlas</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">set_fit_constraints</span><span class="p">(</span><span class="n">num_slopes</span><span class="o">=</span><span class="n">num_slopes</span><span class="p">,</span>
                              <span class="n">range_tolerance</span><span class="o">=</span><span class="n">range_tolerance</span><span class="p">,</span>
                              <span class="n">fit_tolerance</span><span class="o">=</span><span class="n">fit_tolerance</span><span class="p">,</span>
                              <span class="n">polydeg</span><span class="o">=</span><span class="n">polydeg</span><span class="p">,</span>
                              <span class="n">candidate_thresh</span><span class="o">=</span><span class="n">candidate_thresh</span><span class="p">,</span>
                              <span class="n">ransac_thresh</span><span class="o">=</span><span class="n">ransac_thresh</span><span class="p">,</span>
                              <span class="n">xbins</span><span class="o">=</span><span class="n">xbins</span><span class="p">,</span>
                              <span class="n">ybins</span><span class="o">=</span><span class="n">ybins</span><span class="p">,</span>
                              <span class="n">brute_force</span><span class="o">=</span><span class="n">brute_force</span><span class="p">,</span>
                              <span class="n">fittype</span><span class="o">=</span><span class="n">fittype</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sample_size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
                  <span class="n">max_tries</span><span class="o">=</span><span class="n">max_tries</span><span class="p">,</span>
                  <span class="n">top_n</span><span class="o">=</span><span class="n">top_n</span><span class="p">,</span>
                  <span class="n">n_slope</span><span class="o">=</span><span class="n">num_slopes</span><span class="p">,</span>
                  <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                  <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                  <span class="n">coeff</span><span class="o">=</span><span class="n">coeff</span><span class="p">)</span>

        <span class="n">pfit</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_peaks_to_atlas</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pfit</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_peaks_to_atlas</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span> <span class="o">=</span> <span class="n">pfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">=</span> <span class="s1">&#39;poly&#39;</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span><span class="p">,</span>
                       <span class="n">plot_atlas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">log_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div>

<div class="viewcode-block" id="WavelengthPolyFit.calibrate_pfit"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.WavelengthPolyFit.calibrate_pfit">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_pfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">elements</span><span class="p">,</span>
                       <span class="n">pfit</span><span class="p">,</span>
                       <span class="n">min_wave</span><span class="o">=</span><span class="mf">3500.</span><span class="p">,</span>
                       <span class="n">max_wave</span><span class="o">=</span><span class="mf">8500.</span><span class="p">,</span>
                       <span class="n">tolerance</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span>
                       <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">Calibrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">,</span>
                       <span class="n">min_wavelength</span><span class="o">=</span><span class="n">min_wave</span><span class="p">,</span>
                       <span class="n">max_wavelength</span><span class="o">=</span><span class="n">max_wave</span><span class="p">,</span>
                       <span class="n">num_pixels</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">add_atlas</span><span class="p">(</span><span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">,</span>
                    <span class="n">min_wavelength</span><span class="o">=</span><span class="n">min_wave</span><span class="p">,</span>
                    <span class="n">max_wavelength</span><span class="o">=</span><span class="n">max_wave</span><span class="p">)</span>
        <span class="n">pfit</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_peaks_to_atlas</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>
        <span class="n">pfit</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_peaks_to_atlas</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pfit</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">match_peaks_to_atlas</span><span class="p">(</span><span class="n">pfit</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span> <span class="o">=</span> <span class="n">pfit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">=</span> <span class="s1">&#39;poly&#39;</span>

        <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">plot_fit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arc_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span><span class="p">,</span>
                       <span class="n">plot_atlas</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">log_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="StandardFlux"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.StandardFlux">[docs]</a><span class="k">class</span> <span class="nc">StandardFlux</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">ftype</span><span class="o">=</span><span class="s1">&#39;flux&#39;</span><span class="p">,</span> <span class="n">silence</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">=</span> <span class="n">ftype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silence</span> <span class="o">=</span> <span class="n">silence</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_standard</span><span class="p">()</span>

<div class="viewcode-block" id="StandardFlux._lookup_standard"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.StandardFlux._lookup_standard">[docs]</a>    <span class="k">def</span> <span class="nf">_lookup_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check if the requested standard and library exist.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">target_list</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Requested standard star library does not exist.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">target_list</span><span class="p">:</span>
            <span class="n">best_match</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">get_close_matches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                                                   <span class="n">target_list</span><span class="p">,</span>
                                                   <span class="n">cutoff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cutoff</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Requested standard star is not in the library.&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="s1">&#39;The requrested spectrophotometric library contains: &#39;</span><span class="p">,</span>
                <span class="n">target_list</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Are you looking for these: &#39;</span><span class="p">,</span> <span class="n">best_match</span><span class="p">)</span></div>

<div class="viewcode-block" id="StandardFlux.load_standard"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.StandardFlux.load_standard">[docs]</a>    <span class="k">def</span> <span class="nf">load_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                      <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Read the standard flux/magnitude file. And return the wavelength and</span>
<span class="sd">        flux/mag in units of</span>

<span class="sd">        wavelength: A</span>
<span class="sd">        flux:       ergs / cm / cm / s / A</span>
<span class="sd">        mag:        mag (AB) </span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        display: tuple, optional</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string, optional</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple, optional</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">flux_multiplier</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;iraf&#39;</span><span class="p">:</span>
            <span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;flux&#39;</span><span class="p">:</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="s1">&#39;f&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">!=</span> <span class="s1">&#39;xshooter&#39;</span><span class="p">:</span>
                    <span class="n">flux_multiplier</span> <span class="o">=</span> <span class="mf">1e-16</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;mag&#39;</span><span class="p">:</span>
                <span class="n">target_name</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39;.dat&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The type has to be </span><span class="se">\&#39;</span><span class="s1">flux</span><span class="se">\&#39;</span><span class="s1"> of </span><span class="se">\&#39;</span><span class="s1">mag</span><span class="se">\&#39;</span><span class="s1">.&#39;</span><span class="p">)</span>

        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="s1">&#39;standards&#39;</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;stan&#39;</span><span class="p">,</span> <span class="n">target_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;iraf&#39;</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

        <span class="n">wave</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;iraf&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftype</span> <span class="o">==</span> <span class="s1">&#39;flux&#39;</span><span class="p">):</span>
            <span class="n">fluxmag</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">f</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">))</span> <span class="o">*</span> <span class="mf">3630.780548</span> <span class="o">/</span> <span class="mf">3.34e4</span> <span class="o">/</span> <span class="n">wave</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fluxmag</span> <span class="o">=</span> <span class="n">f</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">flux_multiplier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">=</span> <span class="n">wave</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std</span> <span class="o">=</span> <span class="n">fluxmag</span>

        <span class="c1"># Note that if the renderer does not generate any image (e.g. JSON)</span>
        <span class="c1"># nothing will be displayed</span>
        <span class="k">if</span> <span class="n">display</span> <span class="o">&amp;</span> <span class="n">plotly_imported</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inspect_standard</span><span class="p">(</span><span class="n">renderer</span><span class="p">,</span> <span class="n">jsonstring</span><span class="p">)</span></div>

<div class="viewcode-block" id="StandardFlux.inspect_standard"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.StandardFlux.inspect_standard">[docs]</a>    <span class="k">def</span> <span class="nf">inspect_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>

        <span class="c1"># show the image on the top</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std</span><span class="p">,</span>
                       <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">)))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftype</span><span class="p">,</span>
            <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\text{Wavelength / A}$&#39;</span><span class="p">,</span>
            <span class="n">yaxis_title</span><span class="o">=</span>
            <span class="sa">r</span><span class="s1">&#39;$\text{Flux / ergs cm}^{-2} \text</span><span class="si">{s}</span><span class="s1">^{-1} \text</span><span class="si">{A}</span><span class="s1">^{-1}$&#39;</span><span class="p">,</span>
            <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="OneDSpec"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec">[docs]</a><span class="k">class</span> <span class="nc">OneDSpec</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">science</span><span class="p">,</span>
                 <span class="n">wave_cal</span><span class="p">,</span>
                 <span class="n">standard</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">wave_cal_std</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">flux_cal</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        science: TwoDSpec object</span>

<span class="sd">        wave_cal: WavelengthPolyFit object</span>

<span class="sd">        standard: TwoDSpec object, optional</span>

<span class="sd">        wave_cal_std: WavelengthPolyFit object, optional</span>

<span class="sd">        flux_cal: StandardFlux object, optional (require wave_cal_std)</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adu</span> <span class="o">=</span> <span class="n">science</span><span class="o">.</span><span class="n">adu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aduerr</span> <span class="o">=</span> <span class="n">science</span><span class="o">.</span><span class="n">aduerr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyadu</span> <span class="o">=</span> <span class="n">science</span><span class="o">.</span><span class="n">skyadu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime</span> <span class="o">=</span> <span class="n">science</span><span class="o">.</span><span class="n">exptime</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nspec</span> <span class="o">=</span> <span class="n">science</span><span class="o">.</span><span class="n">nspec</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid TwoDSpec.&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_wavecal</span><span class="p">(</span><span class="n">wave_cal</span><span class="p">,</span> <span class="s1">&#39;science&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a WavelengthPolyFit.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_standard</span><span class="p">(</span><span class="n">standard</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standard_imported</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">standard_imported</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The TwoDSpec of the standard observation is not &#39;</span>
                          <span class="s1">&#39;available. Flux calibration will not be performed.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wave_cal_std</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_wavecal</span><span class="p">(</span><span class="n">wave_cal_std</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wav_cal_std_imported</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">wave_cal_std</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">standard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_wavecal</span><span class="p">(</span><span class="n">wave_cal</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wav_cal_std_imported</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;The WavelengthPolyFit of the standard observation &#39;</span>
                <span class="s1">&#39;is not available. The wavelength calibration for the science &#39;</span>
                <span class="s1">&#39;frame is applied to the standard.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">flux_cal</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_fluxcal</span><span class="p">(</span><span class="n">flux_cal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_imported</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_imported</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The StandardFlux of the standard star is not &#39;</span>
                          <span class="s1">&#39;available. Flux calibration will not be performed.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="OneDSpec._set_standard"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec._set_standard">[docs]</a>    <span class="k">def</span> <span class="nf">_set_standard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">standard</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract the required information from a TwoDSpec object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span> <span class="o">=</span> <span class="n">standard</span><span class="o">.</span><span class="n">adu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aduerr_std</span> <span class="o">=</span> <span class="n">standard</span><span class="o">.</span><span class="n">aduerr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyadu_std</span> <span class="o">=</span> <span class="n">standard</span><span class="o">.</span><span class="n">skyadu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exptime_std</span> <span class="o">=</span> <span class="n">standard</span><span class="o">.</span><span class="n">exptime</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid TwoDSpec.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OneDSpec._set_wavecal"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec._set_wavecal">[docs]</a>    <span class="k">def</span> <span class="nf">_set_wavecal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave_cal</span><span class="p">,</span> <span class="n">stype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract the required information from a WavelengthPolyFit object</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;science&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;poly&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;fittype must be: (1) poly; (2) legendre; or &#39;</span>
                        <span class="s1">&#39;(3) chebyshev&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid WavelengthPolyFit.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type_std</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_std</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type_std</span> <span class="o">==</span> <span class="s1">&#39;poly&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type_std</span> <span class="o">==</span> <span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type_std</span> <span class="o">==</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;fittype must be: (1) poly; (2) legendre; or &#39;</span>
                        <span class="s1">&#39;(3) chebyshev&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid WavelengthPolyFit.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type_std</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit_type</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pfit_std</span> <span class="o">=</span> <span class="n">wave_cal</span><span class="o">.</span><span class="n">pfit</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;poly&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;legendre&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfit_type</span> <span class="o">==</span> <span class="s1">&#39;chebyshev&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">polyval_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">chebyshev</span><span class="o">.</span><span class="n">chebval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s1">&#39;fittype must be: (1) poly; (2) legendre; or &#39;</span>
                        <span class="s1">&#39;(3) chebyshev&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid WavelengthPolyFit.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown stype, please choose from (1) science; &#39;</span></div>
                             <span class="s1">&#39;(2) standard; or (3) all.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="OneDSpec._set_fluxcal"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec._set_fluxcal">[docs]</a>    <span class="k">def</span> <span class="nf">_set_fluxcal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux_cal</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Extract the required information from a StandardFlux object.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">=</span> <span class="n">flux_cal</span><span class="o">.</span><span class="n">group</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">flux_cal</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">=</span> <span class="n">flux_cal</span><span class="o">.</span><span class="n">wave_std</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std_true</span> <span class="o">=</span> <span class="n">flux_cal</span><span class="o">.</span><span class="n">fluxmag_std</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Please provide a valid StandardFlux.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="OneDSpec.apply_wavelength_calibration"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec.apply_wavelength_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">apply_wavelength_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stype</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply the wavelength calibration</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;science&#39;</span><span class="p">:</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adu</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit</span><span class="p">,</span> <span class="n">pix</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">standard_imported</span><span class="p">:</span>
                <span class="n">pix_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit_std</span><span class="p">,</span> <span class="n">pix_std</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span>
                    <span class="s1">&#39;The TwoDSpec of the standard &#39;</span>
                    <span class="s1">&#39;observation is not available. Flux calibration will not &#39;</span>
                    <span class="s1">&#39;be performed.&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="n">pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adu</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">pix_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit</span><span class="p">,</span> <span class="n">pix</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pfit_std</span><span class="p">,</span> <span class="n">pix_std</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown stype, please choose from (1) science; &#39;</span></div>
                             <span class="s1">&#39;(2) standard; or (3) all.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="OneDSpec.compute_sencurve"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec.compute_sencurve">[docs]</a>    <span class="k">def</span> <span class="nf">compute_sencurve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                         <span class="n">kind</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">slength</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                         <span class="n">sorder</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                         <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the standard flux or magnitude of the given target and group</span>
<span class="sd">        based on the given array of wavelengths. Some standard libraries</span>
<span class="sd">        contain the same target with slightly different values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kind: string or integer [1,2,3,4,5 only]</span>
<span class="sd">            interpolation kind</span>
<span class="sd">            &gt;&gt;&gt; [‘linear’, ‘nearest’, ‘zero’, ‘slinear’, ‘quadratic’, ‘cubic’,</span>
<span class="sd">                 ‘previous’, ‘next’]</span>
<span class="sd">            (default is &#39;cubic&#39;)</span>
<span class="sd">        smooth: tuple</span>
<span class="sd">            set to smooth the input ADU/flux/mag with scipy.signal.savgol_filter</span>
<span class="sd">            (default is True)</span>
<span class="sd">        slength: int</span>
<span class="sd">            SG-filter window size</span>
<span class="sd">        sorder: int</span>
<span class="sd">            SG-filter polynomial order</span>
<span class="sd">        display: tuple, optional</span>
<span class="sd">            Set to True to display disgnostic plot.</span>
<span class="sd">        renderer: string, optional</span>
<span class="sd">            plotly renderer options.</span>
<span class="sd">        jsonstring: tuple, optional</span>
<span class="sd">            set to True to return json string that can be rendered by Plotly</span>
<span class="sd">            in any support language.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A scipy interp1d object.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Get the standard flux/magnitude</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slength</span> <span class="o">=</span> <span class="n">slength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sorder</span> <span class="o">=</span> <span class="n">sorder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span> <span class="o">=</span> <span class="n">smooth</span>

        <span class="c1"># Compute bin sizes such that the bin is roughly 10 A wide</span>
        <span class="c1">#wave_range = self.wave_std[-1] - self.wave_std[0]</span>
        <span class="c1">#bin_size = self.wave_std[1] - self.wave_std[0]</span>

        <span class="c1"># Find the centres of the first and last bins such that</span>
        <span class="c1"># the old and new spectra covers identical wavelength range</span>
        <span class="c1">#wave_lhs = self.wave_std[0] - bin_size / 2.</span>
        <span class="c1">#wave_rhs = self.wave_std[-1] + bin_size / 2.</span>
        <span class="c1">#wave_obs = np.arange(wave_lhs, wave_rhs, bin_size)</span>
        <span class="c1">#wave_std = self.wave_std</span>

        <span class="k">if</span> <span class="n">spectres_imported</span><span class="p">:</span>
            <span class="c1"># resampling both the observed and the database standard spectra</span>
            <span class="c1"># in unit of flux per second</span>
            <span class="n">flux_std</span> <span class="o">=</span> <span class="n">spectres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime_std</span><span class="p">)</span>
            <span class="n">flux_std_true</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std_true</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flux_std</span> <span class="o">=</span> <span class="n">flux_std</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">exptime_std</span>
            <span class="n">flux_std_true</span> <span class="o">=</span> <span class="n">itp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std_true</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_obs</span><span class="p">)</span>
        <span class="c1"># Get the sensitivity curve</span>
        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">flux_std_true</span> <span class="o">/</span> <span class="n">flux_std</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">sensitivity</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&lt;</span> <span class="mf">6850.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&gt;</span> <span class="mf">7000.</span><span class="p">))</span> <span class="o">&amp;</span>
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&lt;</span> <span class="mf">7150.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&gt;</span> <span class="mf">7400.</span><span class="p">))</span> <span class="o">&amp;</span>
                <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&lt;</span> <span class="mf">7575.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span> <span class="o">&gt;</span> <span class="mf">7775.</span><span class="p">)))</span>

        <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">wave_std</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">flux_std</span> <span class="o">=</span> <span class="n">flux_std</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="c1"># apply a Savitzky-Golay filter to remove noise and Telluric lines</span>
        <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
            <span class="n">sensitivity</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">savgol_filter</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">,</span> <span class="n">slength</span><span class="p">,</span> <span class="n">sorder</span><span class="p">)</span>

        <span class="n">sencurve</span> <span class="o">=</span> <span class="n">itp</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">wave_std</span><span class="p">,</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">sensitivity</span><span class="p">),</span>
                                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                                <span class="n">fill_value</span><span class="o">=</span><span class="s1">&#39;extrapolate&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="n">sensitivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span> <span class="o">=</span> <span class="n">sencurve</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave_sen</span> <span class="o">=</span> <span class="n">wave_std</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux_sen</span> <span class="o">=</span> <span class="n">flux_std</span>

        <span class="c1"># Diagnostic plot</span>
        <span class="k">if</span> <span class="n">display</span> <span class="o">&amp;</span> <span class="n">plotly_imported</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inspect_sencurve</span><span class="p">()</span></div>

<div class="viewcode-block" id="OneDSpec.inspect_sencurve"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec.inspect_sencurve">[docs]</a>    <span class="k">def</span> <span class="nf">inspect_sencurve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Display the computed sensitivity curve.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="c1"># show the image on the top</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_sen</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_sen</span><span class="p">,</span>
                       <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ADU (Observed)&#39;</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_sen</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sensitivity</span><span class="p">,</span>
                       <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span>
                       <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sensitivity Curve&#39;</span><span class="p">))</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_sen</span><span class="p">,</span>
                       <span class="n">y</span><span class="o">=</span><span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_sen</span><span class="p">),</span>
                       <span class="n">yaxis</span><span class="o">=</span><span class="s1">&#39;y2&#39;</span><span class="p">,</span>
                       <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Best-fit Sensitivity Curve&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;SG(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slength</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span>
                              <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sorder</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)-Smoothed &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">+</span>
                              <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                              <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Smoothed ADU&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">group</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span><span class="p">,</span>
                              <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;ADU&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                          <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">xaxis_title</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$\text{Wavelength / A}$&#39;</span><span class="p">,</span>
                          <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;ADU&#39;</span><span class="p">),</span>
                          <span class="n">yaxis2</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Sensitivity Curve&#39;</span><span class="p">,</span>
                                      <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span>
                                      <span class="n">anchor</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
                                      <span class="n">overlaying</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span>
                                      <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">),</span>
                          <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                  <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                                  <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                                      <span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                                      <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                      <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                                  <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                          <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span></div>

<div class="viewcode-block" id="OneDSpec.apply_flux_calibration"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec.apply_flux_calibration">[docs]</a>    <span class="k">def</span> <span class="nf">apply_flux_calibration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply the computed sensitivity curve</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;science&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxerr</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aduerr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyflux</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyadu</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxerr_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aduerr_std</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyflux_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyadu_std</span>
        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxerr</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aduerr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyflux</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyadu</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">adu_std</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxerr_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">aduerr_std</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">skyflux_std</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">sencurve</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">skyadu_std</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown stype, please choose from (1) science; &#39;</span></div>
                             <span class="s1">&#39;(2) standard; or (3) all.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="OneDSpec.inspect_reduced_spectrum"><a class="viewcode-back" href="../autoapi/aspired/index.html#aspired.OneDSpec.inspect_reduced_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">inspect_reduced_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">stype</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span>
                                 <span class="n">wave_min</span><span class="o">=</span><span class="mf">4000.</span><span class="p">,</span>
                                 <span class="n">wave_max</span><span class="o">=</span><span class="mf">8000.</span><span class="p">,</span>
                                 <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span>
                                 <span class="n">jsonstring</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Display the reduced spectra.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;science&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">):</span>

                <span class="n">wave_mask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">&gt;</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">&lt;</span> <span class="n">wave_max</span><span class="p">))</span>
                <span class="n">flux_mask</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">wave_mask</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">wave_mask</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
                <span class="n">flux_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">flux_mask</span><span class="p">]))</span>
                <span class="n">flux_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">flux_mask</span><span class="p">]))</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
                <span class="c1"># show the image on the top</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux Uncertainty&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skyflux</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sky Flux&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                                  <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Wavelength / A&#39;</span><span class="p">,</span>
                                             <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">]),</span>
                                  <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                                             <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">flux_min</span><span class="p">,</span> <span class="n">flux_max</span><span class="p">],</span>
                                             <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">),</span>
                                  <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span>
                                      <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                      <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                                <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                      <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                                  <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;standard&#39;</span><span class="p">:</span>

            <span class="n">wave_std_mask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">&gt;</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">&lt;</span> <span class="n">wave_max</span><span class="p">))</span>
            <span class="n">flux_std_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">&gt;</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">wave_std_mask</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">&lt;</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">wave_std_mask</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
            <span class="n">flux_std_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">flux_std_mask</span><span class="p">]))</span>
            <span class="n">flux_std_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">flux_std_mask</span><span class="p">]))</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
            <span class="c1"># show the image on the top</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxerr_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux Uncertainty&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skyflux_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sky Flux&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std_true</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Standard&#39;</span><span class="p">))</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                              <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Wavelength / A&#39;</span><span class="p">,</span>
                                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">]),</span>
                              <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                                         <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">flux_std_min</span><span class="p">,</span> <span class="n">flux_std_max</span><span class="p">],</span>
                                         <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">),</span>
                              <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                      <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                      <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                                      <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                                                          <span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                                          <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                          <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                                      <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                              <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nspec</span><span class="p">):</span>

                <span class="n">wave_mask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">&gt;</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">&lt;</span> <span class="n">wave_max</span><span class="p">))</span>
                <span class="n">flux_mask</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">wave_mask</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">wave_mask</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
                <span class="n">flux_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">flux_mask</span><span class="p">]))</span>
                <span class="n">flux_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">flux_mask</span><span class="p">]))</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
                <span class="c1"># show the image on the top</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux Uncertainty&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                    <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                               <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skyflux</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                               <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sky Flux&#39;</span><span class="p">))</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                                  <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Wavelength / A&#39;</span><span class="p">,</span>
                                             <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">]),</span>
                                  <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                                             <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">flux_min</span><span class="p">,</span> <span class="n">flux_max</span><span class="p">],</span>
                                             <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">),</span>
                                  <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span>
                                      <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                      <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                                <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                      <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                                  <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">jsonstring</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>

            <span class="n">wave_std_mask</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">&gt;</span> <span class="n">wave_min</span><span class="p">)</span> <span class="o">&amp;</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span> <span class="o">&lt;</span> <span class="n">wave_max</span><span class="p">))</span>
            <span class="n">flux_std_mask</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">&gt;</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">wave_std_mask</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span> <span class="o">&lt;</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">wave_std_mask</span><span class="p">],</span> <span class="mi">95</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">))</span>
            <span class="n">flux_std_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">flux_std_mask</span><span class="p">]))</span>
            <span class="n">flux_std_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">[</span><span class="n">flux_std_mask</span><span class="p">]))</span>

            <span class="n">fig2</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
            <span class="c1"># show the image on the top</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flux_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">))</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxerr_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Flux Uncertainty&#39;</span><span class="p">))</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">skyflux_std</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;firebrick&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Sky Flux&#39;</span><span class="p">))</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wave_std_true</span><span class="p">,</span>
                           <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fluxmag_std_true</span><span class="p">,</span>
                           <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">),</span>
                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Standard&#39;</span><span class="p">))</span>
            <span class="n">fig2</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
                               <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Wavelength / A&#39;</span><span class="p">,</span>
                                          <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">wave_min</span><span class="p">,</span> <span class="n">wave_max</span><span class="p">]),</span>
                               <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Flux&#39;</span><span class="p">,</span>
                                          <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">flux_std_min</span><span class="p">,</span> <span class="n">flux_std_max</span><span class="p">],</span>
                                          <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">),</span>
                               <span class="n">legend</span><span class="o">=</span><span class="n">go</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">Legend</span><span class="p">(</span>
                                   <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                   <span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">traceorder</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                   <span class="n">font</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="s2">&quot;sans-serif&quot;</span><span class="p">,</span>
                                             <span class="n">size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                                             <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">),</span>
                                   <span class="n">bgcolor</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0)&#39;</span><span class="p">),</span>
                               <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">jsonstring</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">fig</span><span class="o">.</span><span class="n">to_json</span><span class="p">(),</span> <span class="n">fig2</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">renderer</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
                <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig2</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">renderer</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unknown stype, please choose from (1) science; &#39;</span></div></div>
                             <span class="s1">&#39;(2) standard; or (3) all.&#39;</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">ASPIRED</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/pip.html">pip</a></li>
</ul>
<p class="caption"><span class="caption-text">Behind the Scene</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../background/imagereduction.html">Image Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/aptrace.html">Aperture Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/apextract.html">Aperture Extraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/wavecal.html">Wavelength Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../background/fluxcal.html">Flux Calibration</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/lt-sprat.html">Example - SPRAT (Liverpool Telescope)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/wht-isis.html">Example - ISIS (William Herschel Telescope)</a></li>
</ul>
<p class="caption"><span class="caption-text">List of Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules/imagereduction.html">ImageReduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/twodspec.html">TwoDSpec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/onedspec.html">OneDSpec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/wavelengthpolyfit.html">WavelengthPolyFit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standardflux.html">StandardFlux</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../autoapi/index.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Marco Lam.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>